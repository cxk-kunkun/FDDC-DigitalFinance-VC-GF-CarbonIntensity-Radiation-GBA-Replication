/*
================================================================================
==       为广深及五个城市统一生成嵌套权重的 Stata 代码 (手动命名版)
==  理论基础: 核心-腹地理论 (经济依赖性) + 乘法嵌套
==  核心城市: 广州市, 深圳市, 汕头市, 佛山市, 湛江市, 珠海市, 韶关市
================================================================================
*/

clear all
set more off

*-------------------------------------------------------------------------------
*-- 1. 数据准备
*-------------------------------------------------------------------------------
input str10 city pgdp lng lat
"广州市" 13.73533 113.536 23.3484
"韶关市" 4.181967 113.775 24.8205
"深圳市" 16.15295 114.127 22.6546
"珠海市" 13.5293 113.357 22.1701
"汕头市" 3.9371 116.583 23.3334
"佛山市" 11.36835 112.944 23.0064
"江门市" 5.727658 112.67 22.2813
"湛江市" 3.72385 110.164 21.0965
"茂名市" 4.536025 110.951 22.0153
"肇庆市" 5.019958 112.205 23.5376
"惠州市" 7.0664 114.499 23.2427
"梅州市" 2.460942 116.079 24.2028
"汕尾市" 3.10925 115.532 23.0147
"河源市" 3.088633 114.958 24.0445
"阳江市" 4.840708 111.772 22.0394
"清远市" 3.773992 112.874 24.3147
"东莞市" 8.469367 113.876 22.9353
"中山市" 8.797558 113.384 22.5205
"潮州市" 3.688442 116.773 23.7959
"揭阳市" 3.214067 116.117 23.3383
"云浮市" 3.301158 111.794 22.8159
end

*-------------------------------------------------------------------------------
*-- 2. 权重计算核心代码 (为全部七个核心城市循环)
*-------------------------------------------------------------------------------
* 统一指定所有核心城市
local core_cities "广州市 深圳市 汕头市 佛山市 湛江市 珠海市 韶关市"

foreach core_city of local core_cities {
	display ""
	display as result "==================== 正在计算: `core_city' ===================="
	
	* 获取核心城市的经纬度和人均GDP
	qui sum lng if city == "`core_city'"
	local core_lng = r(mean)
	qui sum lat if city == "`core_city'"
	local core_lat = r(mean)
	qui sum pgdp if city == "`core_city'"
	local core_pgdp = r(mean)
	
	* 计算地理距离 (单位: 公里)
	gen double distance = .
	replace distance = 6371 * acos( sin(`core_lat'*_pi/180) * sin(lat*_pi/180) +  /// 
	                         cos(`core_lat'*_pi/180) * cos(lat*_pi/180) *        ///
	                         cos((lng-`core_lng')*_pi/180) ) if city != "`core_city'"
	
	* 计算原始地理权重
	gen double Wgeo_raw = 1 / (distance + 1) if city != "`core_city'"
	
	* *** 关键修正：经济依赖权重 ***
	* 公式：w_eco = 1 / (腹地GDP/核心GDP + 1)
	* 体现：腹地经济规模相对越小，对核心依赖性越强，权重越大
	gen double Weco_raw = 1 / ((pgdp / `core_pgdp') + 1) if city != "`core_city'"

	* *** 关键修正：乘法嵌套权重 ***
	* 体现地理距离和经济依赖的复合交互影响
	gen double W_nested = Wgeo_raw * Weco_raw if city != "`core_city'"
	
	* --- 标准化处理 ---
	* 1. 标准化地理权重
	qui summarize Wgeo_raw if city != "`core_city'"
	local total_Wgeo = r(sum)
	gen double wgeo_`core_city' = 0
	replace wgeo_`core_city' = Wgeo_raw / `total_Wgeo' if city != "`core_city'"

	* 2. 标准化经济权重
	qui summarize Weco_raw if city != "`core_city'"
	local total_Weco = r(sum)
	gen double weco_`core_city' = 0
	replace weco_`core_city' = Weco_raw / `total_Weco' if city != "`core_city'"

	* 3. 标准化嵌套权重
	qui summarize W_nested if city != "`core_city'"
	local total_Wnested = r(sum)
	gen double w_`core_city' = 0
	replace w_`core_city' = W_nested / `total_Wnested' if city != "`core_city'"

	* 清理本次循环的临时变量
	drop distance Wgeo_raw Weco_raw W_nested
}

*-------------------------------------------------------------------------------
*-- 3. 手动重命名权重变量 (命名逻辑不变)
*-------------------------------------------------------------------------------
display ""
display as result "==================== 开始手动重命名权重变量 ===================="

* --- 重命名广州的权重 ---
rename wgeo_广州市 广州地理距离权重
rename weco_广州市 广州经济距离权重
rename w_广州市 广州嵌套权重

* --- 重命名深圳的权重 ---
rename wgeo_深圳市 深圳地理距离权重
rename weco_深圳市 深圳经济距离权重
rename w_深圳市 深圳嵌套权重

* --- 重命名汕头的权重 ---
rename wgeo_汕头市 汕头地理距离权重
rename weco_汕头市 汕头经济距离权重
rename w_汕头市 汕头嵌套权重

* --- 重命名佛山的权重 ---
rename wgeo_佛山市 佛山地理距离权重
rename weco_佛山市 佛山经济距离权重
rename w_佛山市 佛山嵌套权重

* --- 重命名湛江的权重 ---
rename wgeo_湛江市 湛江地理距离权重
rename weco_湛江市 湛江经济距离权重
rename w_湛江市 湛江嵌套权重

* --- 重命名珠海的权重 ---
rename wgeo_珠海市 珠海地理距离权重
rename weco_珠海市 珠海经济距离权重
rename w_珠海市 珠海嵌套权重

* --- 重命名韶关的权重 ---
rename wgeo_韶关市 韶关地理距离权重
rename weco_韶关市 韶关经济距离权重
rename w_韶关市 韶关嵌套权重

display as text "所有核心城市的权重变量已手动重命名完成！"

*-------------------------------------------------------------------------------
*-- 4. 最终结果展示
*-------------------------------------------------------------------------------
display ""
display as result "==================== 计算与重命名完成 ===================="
display as text "以下是所有核心城市的权重变量:"

* 展示权重表
list city 广州地理距离权重 广州经济距离权重 广州嵌套权重 ///
     深圳地理距离权重 深圳经济距离权重 深圳嵌套权重 ///
     汕头地理距离权重 汕头经济距离权重 汕头嵌套权重 ///
     佛山地理距离权重 佛山经济距离权重 佛山嵌套权重 ///
     湛江地理距离权重 湛江经济距离权重 湛江嵌套权重 ///
     珠海地理距离权重 珠海经济距离权重 珠海嵌套权重 ///
     韶关地理距离权重 韶关经济距离权重 韶关嵌套权重, clean

*-------------------------------------------------------------------------------
*-- 5. 权重解释说明
*-------------------------------------------------------------------------------
display ""
display as result "==================== 权重构建说明 ===================="
display as text "1. 地理距离权重：基于球面距离计算，距离越近权重越大"
display as text "2. 经济距离权重：基于腹地/核心GDP比值，体现经济依赖性"
display as text "3. 嵌套权重：地理权重 × 经济权重，体现复合交互影响"
display as text "4. 所有权重均按行标准化，确保每行权重和为1"
display as text "5. 所有核心城市均采用统一的修正后逻辑计算"
